{% extends "base.html" %}

{% block content %}
<h1>{{ title }}</h1>

<div class="card">
    <h2>Fahrtdurchführung bearbeiten</h2>

    <!-- Info zum aktuellen Datensatz -->
    <div class="dataset-info">
        <strong>Aktueller Datensatz:</strong><br>
        ID: {{ fahrt.fahrt_id }}<br>
        Halteplan: {{ fahrt.halteplan.bezeichnung }}<br>
        Zug:
        {% if fahrt.zug_id and fahrt.zug_id != 0 %}
            {{ fahrt.zug_id }}
        {% else %}
            kein Zug
        {% endif %}
    </div>

    <form method="post" class="form-styled" id="fahrt-edit-form">
        {{ form.hidden_tag() }}

        <!-- Status -->
        <div class="form-group">
            {{ form.status.label(class="form-label") }}
            {{ form.status(class="form-input", id="status-select") }}
        </div>

        <!-- Verspätung (nur sichtbar bei Status VERSPAETET, per JS gesteuert) -->
        <div class="form-group" id="verspaetung-group">
            {{ form.verspaetung_min.label(class="form-label") }}
            {{ form.verspaetung_min(class="form-input", id="verspaetung-input") }}
            <small class="hint">
                Verspätung in Minuten (nur bei verspäteten Fahrten relevant).
            </small>
        </div>

        <!-- Mitarbeiter-Zuweisung -->
        <h3 style="margin-top: 30px;">Mitarbeiterzuweisung</h3>

        <p class="info-text">
            Wähle aus, welche Mitarbeiter dieser Fahrt zugeordnet sind.
        </p>

        <div class="mitarbeiter-list">
            {% if mitarbeiter_liste %}
                {% for m in mitarbeiter_liste %}
                    <label class="checkbox-row">
                        <input type="checkbox"
                               name="mitarbeiter_ids"
                               value="{{ m.id }}"
                               {% if m.id in zugewiesene_ids %}checked{% endif %}>
                        {{ m.name }}

                        {% if m.user %}
                            <span class="subtext">({{ m.user.username }})</span>
                        {% endif %}
                    </label>
                {% endfor %}
            {% else %}
                <p>Es sind noch keine Mitarbeiter angelegt.</p>
            {% endif %}
        </div>

        <div class="btn-container" style="margin-top: 25px;">
            <button type="submit" class="btn-primary-small">
                Änderungen speichern
            </button>

            <a href="{{ url_for('fahrten_list') }}" class="btn-secondary-small">
                Zurück zur Übersicht
            </a>

            <a href="{{ url_for('fahrt_delete', fahrt_id=fahrt.fahrt_id) }}"
               class="btn-danger-small"
               style="margin-left: auto;">
                Fahrt löschen
            </a>
        </div>

    </form>
</div>

<style>
    .form-styled {
        max-width: 520px;
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 22px;
    }

    .form-label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }

    .form-input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 15px;
        box-sizing: border-box;
    }

    .dataset-info {
        background: #f6f6f6;
        border: 1px solid #ddd;
        padding: 12px 15px;
        margin-bottom: 25px;
        border-radius: 6px;
    }

    .hint {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
        display: inline-block;
    }

    .info-text {
        font-size: 13px;
        color: #555;
        margin-bottom: 10px;
    }

    .mitarbeiter-list {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px 12px;
        max-height: 260px;
        overflow-y: auto;
        background: #fafafa;
        margin-bottom: 20px;
    }

    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        font-size: 14px;
    }

    .checkbox-row input[type="checkbox"] {
        margin: 0;
    }

    .subtext {
        font-size: 12px;
        color: #777;
        margin-left: 4px;
    }

    .btn-danger-small {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #b02a37;
        background: #dc3545;
        color: #fff;
        font-size: 13px;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-danger-small:hover {
        background: #c82333;
        text-decoration: none;
        color: #fff;
    }
</style>

<script>
    (function() {
        const statusSelect = document.getElementById("status-select");
        const verspaetungGroup = document.getElementById("verspaetung-group");
        const verspaetungInput = document.getElementById("verspaetung-input");

        function updateVerspaetungVisibility() {
            if (!statusSelect) return;

            if (statusSelect.value === "VERSPAETET") {
                verspaetungGroup.style.display = "block";
            } else {
                verspaetungGroup.style.display = "none";
                if (verspaetungInput) {
                    verspaetungInput.value = 0;
                }
            }
        }

        if (statusSelect) {
            statusSelect.addEventListener("change", updateVerspaetungVisibility);
            updateVerspaetungVisibility(); // initial
        }
    })();
</script>

{% endblock %}

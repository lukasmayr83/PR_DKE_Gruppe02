{% extends "base.html" %}

{% block content %}
<h1>{{ title }}</h1>

<div class="card">
    <h2>Fahrtdurchführung bearbeiten</h2>

    <!-- Info zum aktuellen Datensatz -->
    <div class="dataset-info">
        <strong>Aktueller Datensatz:</strong><br>
        ID: {{ fahrt.fahrt_id }}<br>
        Halteplan: {{ fahrt.halteplan.bezeichnung }}<br>
        Zug:
        {% if fahrt.zug_id and fahrt.zug_id != 0 %}
            {{ fahrt.zug_id }}
        {% else %}
            kein Zug
        {% endif %}
    </div>

    <form method="post" class="form-styled" id="fahrt-edit-form">
        {{ form.hidden_tag() }}

        <!-- Abfahrtszeit -->
        <div class="form-group">
            <label class="form-label">Abfahrtszeit</label>
            <input class="form-input"
                   type="datetime-local"
                   name="abfahrt_zeit"
                   required
                   value="{% if fahrt.abfahrt_zeit %}{{ fahrt.abfahrt_zeit.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
            <small class="hint">Basis für alle berechneten Ankunfts-/Abfahrtszeiten entlang der Strecke.</small>
        </div>

        <!-- Zug-Auswahl (Single Select wie Mitarbeiter, aber Radio) -->
        <h3 style="margin-top: 30px;">Zugauswahl</h3>

        <p class="info-text">Wähle den Zug für diese Fahrtdurchführung.</p>

        <div class="mitarbeiter-list">
          {% if alle_zuege %}
            {% for z in alle_zuege %}
              <label class="checkbox-row">
                <input type="radio"
                       name="zug_id"
                       value="{{ z.id }}"
                       {% if fahrt.zug_id == z.id %}checked{% endif %}
                       required>
                {{ z.bezeichnung }}
                <span class="subtext">(ext={{ z.external_id }})</span>
              </label>
            {% endfor %}
          {% else %}
            <p>Es sind noch keine Züge vorhanden (bitte Flotte synchronisieren).</p>
          {% endif %}
        </div>

        <!-- Price Factor -->
        <div class="form-group">
            <label class="form-label">Preisfaktor</label>
            <input class="form-input"
                   type="number"
                   name="price_factor"
                   step="0.01"
                   min="1"
                   required
                   value="{{ (fahrt.price_factor or 1.0) }}">
            <small class="hint">Muss ≥ 1.00 sein.</small>
        </div>

        <!-- Status -->
        <div class="form-group">
            {{ form.status.label(class="form-label") }}
            {{ form.status(class="form-input", id="status-select") }}
        </div>

        <!-- Verspätung (nur sichtbar bei Status VERSPAETET, per JS gesteuert) -->
        <div class="form-group" id="verspaetung-group">
            {{ form.verspaetung_min.label(class="form-label") }}
            {{ form.verspaetung_min(class="form-input", id="verspaetung-input") }}
        </div>

        <!-- Anzeige: berechnete Halte/Zeiten -->
        <h3 style="margin-top: 30px;">Berechnete Haltezeiten</h3>

        <div class="dataset-info">
            {% if halte_rows %}
                <div class="table-wrapper">
                    <table class="table table-striped" style="width:100%;">
                        <thead>
                            <tr>
                                <th style="width:70px;">Pos</th>
                                <th>Bahnhof</th>
                                <th style="width:190px;">Ankunft</th>
                                <th style="width:190px;">Abfahrt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in halte_rows %}
                            <tr>
                                <td>{{ h.position }}</td>
                                <td>{{ h.bahnhof_name }}</td>
                                <td>{{ h.ankunft_zeit or "-" }}</td>
                                <td>{{ h.abfahrt_zeit or "-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="info-text" style="margin:0;">Noch keine Halte berechnet (speichern, um neu zu berechnen).</p>
            {% endif %}
        </div>

        <!-- Anzeige: berechnete Segmente/Preise -->
        <h3 style="margin-top: 30px;">Berechnete Segmente</h3>

        <div class="dataset-info">
            {% if segment_rows %}
                <div class="table-wrapper">
                    <table class="table table-striped" style="width:100%;">
                        <thead>
                            <tr>
                                <th style="width:70px;">Pos</th>
                                <th style="width:140px;">Dauer (min)</th>
                                <th style="width:140px;">Preis</th>
                                <th>Von Halt-ID</th>
                                <th>Nach Halt-ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in segment_rows %}
                            <tr>
                                <td>{{ s.position }}</td>
                                <td>{{ s.duration_min }}</td>
                                <td>{{ "%.2f"|format(s.final_price) }}</td>
                                <td>{{ s.von_halt_id }}</td>
                                <td>{{ s.nach_halt_id }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <small class="hint">Preis = Grundtarif * price_factor.</small>
            {% else %}
                <p class="info-text" style="margin:0;">Noch keine Segmente berechnet (speichern, um neu zu berechnen).</p>
            {% endif %}
        </div>

        <!-- Mitarbeiter-Zuweisung -->
        <h3 style="margin-top: 30px;">Mitarbeiterzuweisung</h3>

        <p class="info-text">
            Wähle aus, welche Mitarbeiter dieser Fahrt zugeordnet sind.
        </p>

        <div class="mitarbeiter-list">
            {% if mitarbeiter_liste %}
                {% for m in mitarbeiter_liste %}
                    <label class="checkbox-row">
                        <input type="checkbox"
                               name="mitarbeiter_ids"
                               value="{{ m.id }}"
                               {% if m.id in zugewiesene_ids %}checked{% endif %}>
                        {{ m.name }}

                        {% if m.user %}
                            <span class="subtext">({{ m.user.username }})</span>
                        {% endif %}
                    </label>
                {% endfor %}
            {% else %}
                <p>Es sind noch keine Mitarbeiter angelegt.</p>
            {% endif %}
        </div>

        <div class="btn-container" style="margin-top: 25px;">
            <button type="submit" class="btn-primary-small">
                Änderungen speichern
            </button>

            <a href="{{ url_for('fahrten_list') }}" class="btn-secondary-small">
                Zurück zur Übersicht
            </a>

            <a href="{{ url_for('fahrt_delete', fahrt_id=fahrt.fahrt_id) }}"
               class="btn-danger-small"
               style="margin-left: auto;">
                Fahrt löschen
            </a>
        </div>

    </form>
</div>

<style>
    .form-styled {
        max-width: 520px;
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 22px;
        max-width: 520px;
    }

    .form-label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
        max-width: 520px;
    }

    .form-input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 15px;
        box-sizing: border-box;
        max-width: 520px;
    }

    .dataset-info {
        background: #f6f6f6;
        border: 1px solid #ddd;
        padding: 12px 15px;
        margin-bottom: 25px;
        border-radius: 6px;
        max-width: 520px;
    }

    .hint {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
        display: inline-block;
    }

    .info-text {
        font-size: 13px;
        color: #555;
        margin-bottom: 10px;
    }

    .mitarbeiter-list {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px 12px;
        max-height: 260px;
        overflow-y: auto;
        background: #fafafa;
        margin-bottom: 20px;
        max-width: 520px;
    }

    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        font-size: 14px;
    }

    .checkbox-row input[type="checkbox"] {
        margin: 0;
    }

    .subtext {
        font-size: 12px;
        color: #777;
        margin-left: 4px;
    }

    .btn-danger-small {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #b02a37;
        background: #dc3545;
        color: #fff;
        font-size: 13px;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-danger-small:hover {
        background: #c82333;
        text-decoration: none;
        color: #fff;
    }
</style>

<script>
    (function() {
        const statusSelect = document.getElementById("status-select");
        const verspaetungGroup = document.getElementById("verspaetung-group");
        const verspaetungInput = document.getElementById("verspaetung-input");

        function updateVerspaetungVisibility() {
            if (!statusSelect) return;

            if (statusSelect.value === "VERSPAETET") {
                verspaetungGroup.style.display = "block";
            } else {
                verspaetungGroup.style.display = "none";
                if (verspaetungInput) {
                    verspaetungInput.value = 0;
                }
            }
        }

        if (statusSelect) {
            statusSelect.addEventListener("change", updateVerspaetungVisibility);
            updateVerspaetungVisibility();
        }
    })();
</script>

{% endblock %}

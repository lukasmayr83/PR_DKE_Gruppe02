{% extends "base.html" %}

{% block content %}
<!--Select2 is a jQuery based replacement for select boxes. It supports searching, remote data sets, and infinite scrolling of results.-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 Installieren -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Bindet die CSS-Datei add_edit.css für das Styling ein -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_edit.css') }}">

<h1>Warnung bearbeiten</h1>

<div class="flex-container">

    <div class="form-wrapper">
        <form method="POST">
            {{ form.hidden_tag() }} <!-- CSRF-Token für Sicherheit (verhindert Cross-Site Request Forgery Angriffe) -->

            <!-- Bezeichnung der Warnung -->
            <p>
                {{ form.bezeichnung.label }}<br> <!-- Label für Bezeichnung -->
                {{ form.bezeichnung() }} <!-- Inputfeld-->
                <!-- zeigt Errors an -->
                {% for error in form.bezeichnung.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </p>
            <!-- Beschreibung der Warnung -->
            <p>
                {{ form.beschreibung.label }}<br> <!-- Label für Beschreibung -->
                {{ form.beschreibung() }} <!-- Inputfeld-->
                <!-- zeigt Errors an -->
                {% for error in form.beschreibung.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </p>
            <!-- Startzeit der Warnung -->
            <p>
                {{ form.startZeit.label }}<br> <!-- Label für Startzeit -->
                {{ form.startZeit(class="form-control", type="datetime-local") }} <!-- Inputfeld-->
                <!-- zeigt Errors an -->
                {% for error in form.startZeit.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </p>
            <!-- Endzeit der Warnung -->
            <p>
                {{ form.endZeit.label }}<br> <!-- Label für Endzeit -->
                {{ form.endZeit(class="form-control", type="datetime-local") }} <!-- Inputfeld-->
                <!-- zeigt Errors an -->
                {% for error in form.endZeit.errors %}
                    <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </p>
            <!-- betroffenen Abschnitte der Warnung -->
            <p>
                {{ form.abschnitt.label }}<br> <!-- Label für Abschnitt -->
                {{ form.abschnitt(id="abschnitte_select", multiple="multiple", style="width: 100%;") }} <!-- Inputfeld-->
                <!-- zeigt Errors an -->
                {% for error in form.abschnitt.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </p>
            <!-- Speichern + Abbrechen Button-->
            <p style="margin-top: 40px;">
                {{ form.submit(class="btn btn-primary") }}
                <a href="{{ url_for('warnung') }}" class="btn btn-secondary" style="margin-left: 10px;">Abbrechen</a>
            </p>
        </form>
    </div>
    <!-- Container für Karte -->
    <div class="map-wrapper">
        <div id="map" style="width:100%; height:100%;"></div>
    </div>
</div>

<script>
    $(document).ready(function() {
        var $select = $('#abschnitte_select');

        // Initialisierung
        $select.select2({

        });

        // Sortierlogik: Zuletzt gewähltes ans Ende
        $select.on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });
    });
</script>


<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    //Karte zeichnen
    let map = L.map('map').setView([47.5162, 14.5501], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);


    let segmentsLayer = L.layerGroup().addTo(map);

    //wird aufgerufen wenn sich die Abschnitte ändern
    function drawSelectedSegments() {
        let selectedIds = $('#abschnitte_select').val(); //holt Werte aus Dropdown

        //löscht alle alten Dinge
        segmentsLayer.clearLayers();

        if (!selectedIds || selectedIds.length === 0) { //keine IDs -> beenden
            return;
        }

        //holt Koordinaten fürs Zeichnen aus der Datenbank
        let fetchPromises = selectedIds.map(id => {
            return fetch(`/api/abschnitt/${id}`).then(response => response.json());
        });

        //wartet bis alle Daten geladen wurden
        Promise.all(fetchPromises)
            .then(results => {
                let bounds = L.latLngBounds(); //Repräsentiert ein Rechteck auf der Karte

                //Iterieren über alle Abschnitte
                results.forEach(data => {
                    if (data.start && data.end) {

                        //extrahiert die Koordinaten
                        let startLatLng = [data.start.lat, data.start.lon];
                        let endLatLng = [data.end.lat, data.end.lon];

                        //Linie zeichnen
                        let polyline = L.polyline([startLatLng, endLatLng], {
                            color: 'orange',
                            weight: 4, //Dicke der Linie
                            opacity: 0.7 //Transparenz 0.0 ganz transparent
                        }).bindTooltip(`<b>Abschnitt:</b> ${data.start.name} -> ${data.end.name}`)
                            .addTo(segmentsLayer);

                        //Popup für Abschnitt
                        polyline.bindPopup(`<b>Abschnitt:</b> ${data.start.name} ➝ ${data.end.name}`);

                        //Marker für Startbahnhof
                        L.marker(startLatLng, {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                }, {
                            title: `Startbahnhof: ${data.start.name}`})
                            .bindPopup(`<b>Startbahnhof:</b> ${data.start.name}`) //wenn man auf den Marker anklickt wird dieser Text angezeigt
                            .addTo(segmentsLayer);

                        //Marker für Endbahnhof
                        L.marker(endLatLng, {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                }, {
                            title: `Endbahnhof: ${data.end.name}` })
                            .bindPopup(`<b>Ende:</b> ${data.end.name}`) //wenn man auf den Marker anklickt wird dieser Text angezeigt
                            .addTo(segmentsLayer);

                        //Bounds erweitern -> alles anzeigt
                        bounds.extend(startLatLng);
                        bounds.extend(endLatLng);
                    }
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds, {padding: [50, 50]}); //Karte auf Bounds zentrieren
                }
            })
            .catch(err => console.error("Fehler beim Laden der Abschnitte:", err));
    }

    //stellt sicher, dass der Code erst nach Laden des HTMLs aufgerufen wird
    $(document).ready(function() {
        var $select = $('#abschnitte_select');

        //änderen sich die ausgewählten Abschnitte
        $select.on("change", function() {
            drawSelectedSegments(); //ruft Methode zum Zeichnen auf
        });
        //einmal so ausgeführt
        drawSelectedSegments();

    });
</script>

{% endblock %}
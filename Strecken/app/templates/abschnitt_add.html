{% extends "base.html" %}

{% block content %}
<style>
    body {
        background-color: #f8f9fa;
    }

/* Container für die gesamte Seite (Formular + Karte) */
.flex-container {
    display: flex;
    gap: 30px; /* Abstand zwischen Eingabe und Karte*/
    max-width: 100%;
    margin: 20px; /*Abstand zum Rand*/
    align-items: flex-start;
}

/* Formular-Bereich (Links) */
.form-wrapper {
    flex: 1;
    max-width: 400px;
    min-width: 300px; /* Formular ist min 300px groß und max 400px groß */
    padding: 25px; /*Abstand Formular-Inhalt und Formularfeld*/
    background-color: #ffffff; /*Hintergrundfarbe*/
    border-radius: 10px; /*Ecken abrunden*/
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /*Schatten*/
}

/* Karten-Bereich (Rechts) */
.map-wrapper {
    flex: 2; /* Karte doppelt so groß wie Eingabefeld */
    min-width: 400px; /*Mindestbreite*/
    height: 75vh; /*Höhe der Karte*/
    border-radius: 10px; /*Ecken abrunden*/
    overflow: hidden; /*saubere Kanten*/
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /*Schatten*/
}

/* Inputfelder und Labels */

/* Abstände der Formulargruppen <p>-Elemente */
.form-wrapper p {
    margin-bottom: 28.5px;
}

/* Beschriftung der Felder */
.form-wrapper label {
    display: block;
    margin-bottom: 5px; /*Abstand zwischen Label und Eingabefeld*/
    font-weight: 600; /*Schriftdicke*/
    color: #343a40; /*Schriftfarbe*/
    font-size: 20px; /*Schriftgröße*/
}

/* Alle Input-Textfelder */
.form-wrapper input[type="text"],
.form-wrapper input[type="number"],
.form-wrapper select{
    width: 100%; /*ganze Breite ausnutzen*/
    padding: 10px 12px;
    border: 1px solid #ced4da; /*Rahmen*/
    border-radius: 6px; /*Ecken abrunden*/
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
    font-size: 16px; /*Schriftgröße*/
}

/* Readonly Felder mit anderer Farbe*/
.form-wrapper input[readonly] {
    background-color: #f8f9fa;
    color: #6c757d; /*Textfarbe*/
}

/* Fokus-Effekt für Inputs wenn user klickt*/
.form-wrapper input[type="text"]:focus:not([readonly]),
.form-wrapper input[type="number"]:focus:not([readonly]),
.form-wrapper select:focus {
    border-color: #007bff; /*Rahmenfarbe*/
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
    background-color: #fff;
}

/* Fehlertexte */
.form-wrapper span[style*="color:red"] {
    font-size: 16px; /*Schriftgröße*/
    margin-top: 15px;
    display: block;
}


/* Buttons */

.btn {
    padding: 10px 20px; /*Abstand noch oben/unten und links/rechts*/
    font-size: 16px;  /*Schriftgröße*/
    border-radius: 6px; /*Ecken abrunden*/
    cursor: pointer; /*Hand-symbol*/
}

/* Abbrechen-Button anpassen */
.btn-secondary {
    background-color: #6c757d; /*Hintergrundfarbe*/
    border-color: #6c757d; /*Rahmenfarbe*/
    color: white !important; /*Schriftfarbe*/
    transition: background-color 0.2s; /*Farbübergang*/
}

/*Abbrechen ändert farbe beim drüber fahren*/
.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
}


/* Abstand der Überschrift von links definieren */
h1 {
    margin-left: 25px;
}

</style>
<h1>Abschnitt hinzufügen</h1>

<div class="flex-container">

    <!-- Links Tabelle-->
    <div class="form-wrapper">
        <form method="POST">
            {{ form.hidden_tag() }}
            <p class="form-group">
                {{ form.startBahnhof.label }}<br>
                {{ form.startBahnhof(class="form-control") }}
                {% for error in form.startBahnhof.errors %}
                    <span style="color:red; display:block;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p class="form-group">
                {{ form.endBahnhof.label }}<br>
                {{ form.endBahnhof(class="form-control") }}
                {% for error in form.endBahnhof.errors %}
                    <span style="color:red; display:block;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>{{ form.max_geschwindigkeit.label }}<br>{{form.max_geschwindigkeit() }}</p>
            <p>{{ form.spurweite.label }}<br>{{ form.spurweite() }}</p>
            <p>{{ form.nutzungsentgelt.label }}<br>{{ form.nutzungsentgelt() }}</p>

            <p>{{ form.submit(class="btn btn-primary") }}
                <a href="{{ url_for('abschnitt') }}" class="btn btn-secondary" style="margin-left: 10px;">Abbrechen</a>
            </p>
        </form>
    </div>

    <!--Rechts Karte-->
    <div class="map-wrapper">
        <div id="map" style="width:100%; height:100%;"></div>
    </div>

</div>


<!--Leaflet CSS + JS-->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    //Erstellt die Karte
    let map = L.map('map').setView([47.5162, 14.5501], 7); //L. steht für Leaflet
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { // z..Zoomlevel; x,y..Koordinaten
    attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let startMarker = null;
    let endMarker = null;
    let routeLine = null;

    //function, um Verbindung zwischen Bahnhöfe zu zeichnen
    function updateRoute() {
        //alte Linie entfernen, falls vorhanden
        if (routeLine) {
            map.removeLayer(routeLine);
        }

        // Wenn beide Marker existieren, zeichne Linie
        if (startMarker && endMarker) {
            let startLatLng = startMarker.getLatLng();
            let endLatLng = endMarker.getLatLng();

            //Linie zwischen den Punkten
            routeLine = L.polyline([startLatLng, endLatLng], {color: 'blue', weight: 4}).addTo(map);
            map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
        }
    }
function fetchStationCoords(id, type) {
        if (!id) return;

        // Hier rufen wir die neue Flask-Route auf
        fetch(`/api/bahnhof/${id}`)
            .then(response => response.json())
            .then(data => {
                // data enthält jetzt: {id: 5, latitude: 48.1, longitude: 16.2}
                const lat = data.latitude;
                const lon = data.longitude;

                if (type === 'start') {
                    if (startMarker) startMarker.setLatLng([lat, lon]);
                    else startMarker = L.marker([lat, lon], {title: "Start"}).addTo(map);
                } else {
                    if (endMarker) endMarker.setLatLng([lat, lon]);
                    else endMarker = L.marker([lat, lon], {title: "Ende"}).addTo(map);
                }

                updateRoute();

                if (!startMarker || !endMarker) {
                    map.setView([lat, lon], 13);
                }
            })
            .catch(err => console.error("Fehler beim Laden der Koordinaten:", err));
    }

    // Event Listener
    const startSelect = document.getElementById("startBahnhof");
    const endSelect = document.getElementById("endBahnhof");

    if (startSelect) {
        startSelect.addEventListener("change", function() {
            fetchStationCoords(this.value, 'start');
        });
    }

    if (endSelect) {
        endSelect.addEventListener("change", function() {
            fetchStationCoords(this.value, 'end');
        });
    }

</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<style>
    .segment-chain { max-width: 600px; }
    .segment-field { margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #f9fafb; }
    select { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; }
    .btn-danger { background-color: #dc3545; color: white; border-radius: 0.25rem; padding: 0.25rem 0.5rem; }
    .btn-danger:hover { background-color: #c82333; }
</style>

<h2>Strecke hinzufügen</h2>
<div style="display: flex; gap: 20px;">

    <div style="flex: 1; max-width: 500px;">
        <form id="strecken-form" method="POST" action="{{ url_for('strecke_add') }}">

            {{ form.hidden_tag() }}

            <p>{{ form.name.label }}<br>{{ form.name(class="form-control", id="name_input") }}</p>

            <p>
                <label for="startBahnhof">Startbahnhof der Strecke:</label><br>

                <input type="text" id="startBahnhof" name="startBahnhof_display" class="form-control bg-light" readonly>
            </p>

            <p>
                <label for="endBahnhof">Endbahnhof der Strecke:</label><br>

                <input type="text" id="endBahnhof" name="endBahnhof_display" class="form-control bg-light" readonly>
            </p>

            <h3 class="mt-4 mb-2">Abschnitts-Kette definieren:</h3>


            <div id="segment-chain" class="segment-chain">

                <p class="text-gray-500" id="loading-message">Lade Abschnittsdaten...</p>
            </div>

            <input type="hidden" id="abschnitt_ids_hidden" name="abschnitt_ids" value="">


            <p id="error-message" class="text-danger mt-2 hidden">Bitte wählen Sie mindestens einen Abschnitt aus.</p>

            <p>
                <button type="submit" id="submit-button" class="btn btn-primary" disabled>
                    {{ form.submit.label.text }}
                </button>
                <a href="{{ url_for('warnung') }}" class="btn btn-secondary" style="margin-left: 10px;">Abbrechen</a>
            </p>
        </form>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
    let allAbschnitte = [];
    let allBahnhoefe = {};
    let selectedChain = [];


    function loadInitialData() {
        const apiUrl = "{{ api_url }}";

        $.ajax({
            url: apiUrl,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#loading-message').remove();

                if (data.abschnitte && data.bahnhoefe) {
                    allAbschnitte = data.abschnitte;
                    allBahnhoefe = data.bahnhoefe;

                    if (allAbschnitte.length > 0) {
                        addNextSegmentField(0); // Starte die Kette
                    } else {
                        $('#segment-chain').html('<p class="text-warning">Keine Abschnitte in der Datenbank gefunden.</p>');
                    }
                } else {
                    $('#segment-chain').html('<p class="text-danger">Fehler: Unerwartetes Datenformat vom Server.</p>');
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#loading-message').remove();
                $('#segment-chain').html('<p class="text-danger">Fehler beim Laden der Abschnitte: ' + textStatus + '</p>');
                console.error("AJAX Error:", errorThrown);
            }
        });
    }


    function addNextSegmentField(currentIndex) {

        const lastEndStationId = currentIndex > 0 ? selectedChain[currentIndex - 1].endBahnhofId : null;
        const filteredAbschnitte = allAbschnitte.filter(abschnitt => {

            const isAlreadySelected = selectedChain.some(s => s.abschnittId === abschnitt.abschnittId);

            if (currentIndex === 0) {
                return !isAlreadySelected;
            } else {

                return abschnitt.startBahnhofId === lastEndStationId && !isAlreadySelected;
            }
        });


        if (filteredAbschnitte.length === 0 && currentIndex > 0) {
             $('#submit-button').prop('disabled', selectedChain.length === 0 || $('#name_input').val().trim().length === 0);
             return;
        }


        const fieldHtml = `
            <div class="segment-field flex items-center space-x-2 bg-gray-50" data-index="${currentIndex}">
                <span style="min-width: 90px;" class="font-medium text-gray-600">${currentIndex === 0 ? 'Start' : 'Weiterer'} Segment:</span>
                <select class="segment-select" data-index="${currentIndex}" required>
                    <option value="">-- Abschnitt auswählen --</option>
                    ${filteredAbschnitte.map(a => `<option value="${a.abschnittId}">${a.name}</option>`).join('')}
                </select>
                ${currentIndex > 0 ? `<button type="button" class="remove-segment btn-danger text-lg">&times;</button>` : ''}
            </div>
        `;

        $('#segment-chain').append(fieldHtml);
        $('#submit-button').prop('disabled', true);
    }


    $('#segment-chain').on('change', '.segment-select', function() {
        const index = parseInt($(this).data('index'));
        const selectedId = parseInt($(this).val());


        $(`.segment-field[data-index]`).filter(function() {
            return parseInt($(this).data('index')) > index;
        }).remove();
        selectedChain.splice(index);

        if (selectedId) {
            const selectedAbschnitt = allAbschnitte.find(a => a.abschnittId === selectedId);
            selectedChain.push(selectedAbschnitt);


            addNextSegmentField(index + 1);
        }

        updateDisplayAndButton();
    });


    $('#segment-chain').on('click', '.remove-segment', function() {
        const fieldToRemove = $(this).closest('.segment-field');
        const indexToRemove = parseInt(fieldToRemove.data('index'));


        $(`.segment-field[data-index]`).filter(function() {
            return parseInt($(this).data('index')) >= indexToRemove;
        }).remove();


        selectedChain.splice(indexToRemove);
        addNextSegmentField(selectedChain.length);

        updateDisplayAndButton();
    });

    function updateDisplayAndButton() {
        const ids = selectedChain.map(a => a.abschnittId);

        $('#abschnitt_ids_hidden').val(ids.join(','));


        if (selectedChain.length > 0) {
            const startBhfId = selectedChain[0].startBahnhofId;
            const endBhfId = selectedChain[selectedChain.length - 1].endBahnhofId;

            $('#startBahnhof').val(allBahnhoefe[startBhfId] || 'Unbekannt');
            $('#endBahnhof').val(allBahnhoefe[endBhfId] || 'Unbekannt');
        } else {
            $('#startBahnhof').val('');
            $('#endBahnhof').val('');
        }


        const isNameValid = $('#name_input').val().trim().length > 0;
        const isChainValid = ids.length > 0;
        const enableSubmit = isChainValid && isNameValid;

        $('#submit-button').prop('disabled', !enableSubmit);

        if (enableSubmit) {
            $('#error-message').hide();
        } else if (!isChainValid) {
             $('#error-message').show();
        }
    }


    $('#name_input').on('input', updateDisplayAndButton);


    $(document).ready(loadInitialData);
</script>
{% endblock %}